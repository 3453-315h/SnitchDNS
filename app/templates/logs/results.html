{% from 'layout/macros.html' import render_pagination with context %}

{% if results.total == 0 %}
<div class="row mt-5">
    <div class="col text-center">
        <div class="alert alert-info">No query logs found</div>
    </div>
</div>
{% else %}
<div class="row mt-5">
    <div class="col">
        <div class="clearfix mb-3">
            <div class="float-right">
                <form action="{{ url_for('logs.export') }}" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    {% for name in params.all_properties() %}
                    <input type="hidden" name="{{ name }}" value="{{ params.get(name) }}">
                    {% endfor %}

                    <button type="submit" class="btn btn-primary">export to csv</button>
                </form>
            </div>
        </div>

        <table class="table table-sm table-striped">
            <thead>
            <tr>
                <th>#</th>
                <th>Domain</th>
                <th>Source IP</th>
                <th class="text-right">Type</th>
                <th class="text-center">Forwarded</th>
                <th class="text-center">Matched</th>
                <th class="text-center">Blocked</th>
                <th class="text-right">Date</th>
                <th class="text-right"></th>
            </tr>
            </thead>
            <tbody>
            {% for result in results.items %}
            <tr>
                <td>{{ loop.index + (params.per_page * (params.page - 1)) }}</td>
                <td style="width: 100%"><a href="{{ url_for('logs.index', domain=result.domain) }}">{{ result.domain }}</a></td>
                <td>{{ result.source_ip }}</td>
                <td class="text-right">{{ result.type }}</td>
                <td class="text-center">
                    {% set class = 'success' if result.forwarded else 'danger' %}
                    {% set icon = 'check' if result.forwarded else 'times' %}
                    <span class="text-{{ class }}"><i class="fas fa-{{ icon }} fa-fw"></i></span>
                </td>
                <td class="text-center">
                    {% set class = 'success' if result.found else 'danger' %}
                    {% set icon = 'check' if result.found else 'times' %}
                    <span class="text-{{ class }}"><i class="fas fa-{{ icon }} fa-fw"></i></span>
                </td>
                <td class="text-center">
                    {% set class = 'success' if result.blocked else 'danger' %}
                    {% set icon = 'check' if result.blocked else 'times' %}
                    <span class="text-{{ class }}"><i class="fas fa-{{ icon }} fa-fw"></i></span>
                </td>
                <td class="text-right" style="white-space: nowrap;">{{ result.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td class="text-right" style="white-space: nowrap;">
                    {% if result.dns_zone_id == 0 and zone_exists(full_domain=result.domain) == False %}
                    <form action="{{ url_for('dns.zone_create_from_log', query_log_id=result.id) }}" method="post" class="d-inline ml-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <a href="{{ url_for('dns.zone_create_from_log', query_log_id=result.id) }}" title="Create a zone for this domain" class="submit-on-click text-info"><i class="fas fa-plus-square"></i></a>
                    </form>
                    {% endif %}

                    <form action="{{ url_for('dns.zone_restriction_create_from_log', query_log_id=result.id) }}" method="post" class="d-inline ml-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <a href="{{ url_for('dns.zone_restriction_create_from_log', query_log_id=result.id) }}" title="Block IP address for this domain" class="submit-on-click text-danger"><i class="fas fa-ban"></i></a>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        {% if results.pages > 1 %}
            {{ render_pagination(results, page_url, params.url()) }}
        {% endif %}
    </div>
</div>
{% endif %}